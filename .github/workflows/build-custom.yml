name: Build Saurus Safra (Visual Fix)

on:
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-2022
    
    env:
      LIBCLANG_PATH: "C:\\Program Files\\LLVM\\bin"
      RUSTDESK_API_SERVER: "" 
      VCPKG_BINARY_SOURCES: "clear;default,readwrite"

    steps:
    - name: Checkout source code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    # --- CACHES ---
    - name: Cache Rust Dependencies
      uses: swatinem/rust-cache@v2
      with:
        workspaces: .

    - name: Cache VCPKG Archives
      uses: actions/cache@v4
      with:
        path: C:\Users\runneradmin\AppData\Local\vcpkg\archives
        key: vcpkg-archives-${{ runner.os }}-${{ hashFiles('vcpkg.json') }}
        restore-keys: |
          vcpkg-archives-${{ runner.os }}-

    - name: Cache Flutter Packages
      uses: actions/cache@v4
      with:
        path: |
          flutter/.pub-cache
          flutter/.dart_tool
        key: flutter-pub-${{ runner.os }}-${{ hashFiles('flutter/pubspec.yaml') }}
        restore-keys: |
          flutter-pub-${{ runner.os }}-

    # --- SETUP ---
    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.22.2'
        channel: 'stable'

    - name: Install LLVM
      run: |
        choco install llvm -y
        echo "C:\Program Files\LLVM\bin" >> $env:GITHUB_PATH
      shell: powershell

    # --- CUSTOMIZAÇÃO VISUAL (MODO AGRESSIVO) ---
    - name: Apply Safra Theme
      shell: powershell
      run: |
        Write-Host "Aplicando tema Saurus-Safra..."
        
        # Cores (Azul Marinho e Dourado)
        $SafraNavy = "0xFF132047"
        $SafraGold = "0xFFD4AF37"
        
        # Arquivos para tentar a troca
        $FilesToPatch = @("flutter/lib/common.dart", "flutter/lib/theme.dart", "flutter/lib/main.dart")
        
        foreach ($File in $FilesToPatch) {
            if (Test-Path $File) {
                Write-Host "Processando: $File"
                $content = Get-Content $File -Raw
                
                # 1. Troca o Azul Primario (Case Insensitive)
                # Procura por 0xFF2196F3 ou Colors.blue e troca pelo Navy
                if ($content -match "0xFF2196F3") { Write-Host "  > Encontrou Hex Azul. Trocando..." }
                $content = $content -replace '0x[Ff][Ff]2196[Ff]3', $SafraNavy
                
                if ($content -match "Colors\.blue") { Write-Host "  > Encontrou Colors.blue. Trocando..." }
                $content = $content -replace 'Colors\.blue', "Color($SafraNavy)"
                
                # 2. Troca o Azul de Destaque (Lighter Blue) pelo Dourado
                $content = $content -replace '0x[Ff][Ff]1890[Ff][Ff]', $SafraGold
                
                Set-Content -Path $File -Value $content -Encoding UTF8
            }
        }
        
        # --- BONUS: DOWNLOAD DO LOGO ---
        # Tenta baixar o logo novamente para garantir a identidade visual completa
        try {
            $UrlLogo = "https://blob.saurus.net.br/drive/clientes/cliente_testeslucaspt1/logoRust.png"
            $Dest = "flutter/assets/images/logo.png"
            if (Test-Path $Dest) {
                Invoke-WebRequest -Uri $UrlLogo -OutFile $Dest -ErrorAction Stop
                Write-Host "Logo atualizado no Flutter!"
            }
        } catch { Write-Warning "Nao foi possivel baixar o logo." }

    # --- CONFIGURAÇÃO DO SERVIDOR ---
    - name: Inject Server Configuration
      shell: powershell
      run: |
        $ConfigFile = "libs/hbb_common/src/config.rs"
        if (Test-Path $ConfigFile) {
           $content = Get-Content $ConfigFile -Raw
           $content = $content -replace '(?s)pub const RENDEZVOUS_SERVERS:.*?;', 'pub const RENDEZVOUS_SERVERS: &''static [&''static str] = &["20.195.216.23:443"];'
           $content = $content -replace '(?s)pub const RS_PUB_KEY:.*?;', 'pub const RS_PUB_KEY: &''static str = "20.195.216.23";'
           Set-Content -Path $ConfigFile -Value $content -Encoding UTF8
        }

    # --- DEPENDÊNCIAS E COMPILAÇÃO ---
    - name: Fix Flutter Dependencies
      working-directory: ./flutter
      shell: powershell
      run: |
        $File = "pubspec.yaml"
        $Content = Get-Content $File -Raw
        $NewContent = $Content -replace 'extended_text:.*', 'extended_text: ^13.0.0'
        Set-Content -Path $File -Value $NewContent -Encoding UTF8

    - name: Prepare Flutter Dependencies
      working-directory: ./flutter
      run: flutter pub get
      shell: cmd

    - name: Install Flutter Rust Bridge Codegen
      run: |
        cargo install flutter_rust_bridge_codegen --version 1.80.1 --features uuid
      shell: powershell

    - name: Generate Bridge Code
      shell: powershell
      run: |
        $env:PATH += ";C:\Users\runneradmin\.cargo\bin"
        flutter_rust_bridge_codegen --rust-input src/flutter_ffi.rs --dart-output flutter/lib/generated_bridge.dart --rust-output src/bridge_generated.rs

    - name: Install C++ Libs (VCPKG)
      shell: powershell
      run: |
        vcpkg install --triplet x64-windows-static
        $BaseDir = Get-Location
        $IncludePath = Join-Path $BaseDir "vcpkg_installed\x64-windows-static\include"
        $LibPath = Join-Path $BaseDir "vcpkg_installed\x64-windows-static\lib"
        echo "BINDGEN_EXTRA_CLANG_ARGS=-I$IncludePath" >> $env:GITHUB_ENV
        echo "CPATH=$IncludePath" >> $env:GITHUB_ENV
        echo "RUSTFLAGS=-L native=$LibPath" >> $env:GITHUB_ENV
        echo "VCPKG_ROOT=$BaseDir" >> $env:GITHUB_ENV

    - name: Build RustDesk
      run: python build.py --flutter
      env:
        VCPKG_DEFAULT_TRIPLET: "x64-windows-static"
    
    # --- EMPACOTAMENTO ---
    - name: Prepare Output
      shell: powershell
      run: |
        New-Item -ItemType Directory -Force -Path "Saurus_Safra_Edition"
        $Files = Get-ChildItem -Path . -Recurse -Filter "rustdesk.exe" -ErrorAction SilentlyContinue | Where-Object { $_.FullName -notmatch "vcpkg" -and $_.FullName -notmatch "node_modules" }
        
        if ($Files) {
            $Best = $Files | Sort-Object LastWriteTime -Descending | Select-Object -First 1
            $SourceFolder = $Best.Directory.FullName
            Write-Host "Empacotando de: $SourceFolder"
            Copy-Item -Path "$SourceFolder\*" -Destination "Saurus_Safra_Edition" -Recurse -Force
        } else { exit 1 }

    - name: Upload Safra Edition
      uses: actions/upload-artifact@v4
      with:
        name: Saurus-Safra-Edition
        path: Saurus_Safra_Edition
