name: Build Custom RustDesk Windows

on:
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-2022
    
    steps:
    - name: Checkout source code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Setup VCPKG (Manifest Mode)
      # Apenas garante que o vcpkg está atualizado e pronto para ler o vcpkg.json
      run: |
        vcpkg integrate install
      shell: cmd

    - name: Hardcode Server Settings
      shell: powershell
      run: |
        $ConfigFile = "libs/hbb_common/src/config.rs"
        
        # Le o arquivo original
        $content = Get-Content $ConfigFile
        
        # 1. Define o Servidor de ID e Relay (Rendezvous)
        $content = $content -replace 'pub const RENDEZVOUS_SERVERS:.*', 'pub const RENDEZVOUS_SERVERS: &''static [&''static str] = &["20.195.216.23"];'
        
        # 2. Define a Key como o IP (conforme seu teste)
        $content = $content -replace 'pub const RS_PUB_KEY:.*', 'pub const RS_PUB_KEY: &''static str = "20.195.216.23";'
        
        # 3. Força a API ser vazia para evitar erros de login web
        # (O RustDesk usa uma variavel padrao, vamos tentar injetar vazio se houver)
        # Se nao houver a constante explicita, o env var no build resolve.
        
        $content | Set-Content $ConfigFile
        
        Write-Host "Configuracoes aplicadas: ID/Relay = 20.195.216.23 | Key = 20.195.216.23"

    - name: Build Release
      # O comando build vai disparar o vcpkg automaticamente via cargo
      run: cargo build --release --features inline
      env:
        RUSTDESK_API_SERVER: "" # Garante API vazia
        VCPKG_ROOT: "C:\\vcpkg"

    - name: Upload .exe
      uses: actions/upload-artifact@v4
      with:
        name: rustdesk-custom-host
        path: target/release/rustdesk.exe
