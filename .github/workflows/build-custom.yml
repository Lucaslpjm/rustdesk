name: Build Saurus Remote

on:
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-2022
    
    env:
      # Caminhos essenciais
      VCPKG_ROOT: "C:\\vcpkg"
      LIBCLANG_PATH: "C:\\Program Files\\LLVM\\bin"
      RUSTDESK_API_SERVER: "" 

    steps:
    - name: Checkout source code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: 'stable'

    # 1. INSTALAÇÃO DO LLVM (Obrigatório para o Opus)
    - name: Install LLVM
      run: |
        choco install llvm -y
        echo "C:\Program Files\LLVM\bin" >> $env:GITHUB_PATH
      shell: powershell

    # 2. INSTALAÇÃO MANUAL DAS DEPENDÊNCIAS (A "Marreta")
    # Isso garante que os arquivos .h existam fisicamente no disco antes do build começar
    - name: Force Install Dependencies via VCPKG
      run: |
        vcpkg install libvpx:x64-windows-static libyuv:x64-windows-static opus:x64-windows-static aom:x64-windows-static
      shell: cmd

    # --- CUSTOMIZAÇÃO VISUAL (SAURUS REMOTE) ---
    - name: Apply Customizations (Branding)
      shell: powershell
      run: |
        # Links fornecidos por voce
        $UrlIcone = "https://blob.saurus.net.br/drive/clientes/cliente_testeslucaspt1/icoRust.ico"
        $UrlLogo  = "https://blob.saurus.net.br/drive/clientes/cliente_testeslucaspt1/logoRust.png"
        
        Write-Host "Baixando logos..."
        try {
            Invoke-WebRequest -Uri $UrlIcone -OutFile "res/icon.ico" -ErrorAction Stop
            Invoke-WebRequest -Uri $UrlLogo -OutFile "res/logo.png" -ErrorAction Stop
            
            # Copia para pasta do Flutter
            if (Test-Path "flutter/assets/images/logo.png") {
                Copy-Item "res/logo.png" -Destination "flutter/assets/images/logo.png" -Force
            }
            Write-Host "Logos baixados com sucesso!"
        } catch {
            Write-Warning "Erro ao baixar logos. Verifique os links. O build continuara com logos padrao."
        }

        # Cor Azul Saurus (#1E2044)
        $SafraBlue = "0xFF1E2044" 
        $CommonFile = "flutter/lib/common.dart"
        if (Test-Path $CommonFile) {
            $c = Get-Content $CommonFile
            $c = $c -replace '0xFF2196F3', $SafraBlue
            $c | Set-Content $CommonFile
            Write-Host "Cor Saurus aplicada!"
        }

        # Nome da Aplicação e Servidor
        $ConfigFile = "libs/hbb_common/src/config.rs"
        if (Test-Path $ConfigFile) {
           $c = Get-Content $ConfigFile
           
           # Nome APP_NAME
           $c = $c -replace 'pub const APP_NAME.*', 'pub const APP_NAME: Arc<RwLock<String>> = Arc::new(RwLock::new("Saurus Remote".to_string()));'
           
           # Configura IP
           $c = $c -replace 'pub const RENDEZVOUS_SERVERS:.*', 'pub const RENDEZVOUS_SERVERS: &''static [&''static str] = &["20.195.216.23"];'
           $c = $c -replace 'pub const RS_PUB_KEY:.*', 'pub const RS_PUB_KEY: &''static str = "20.195.216.23";'
           $c | Set-Content $ConfigFile
        }

        # Titulo da Janela
        $WinMain = "windows/runner/main.cpp"
        if (Test-Path $WinMain) {
            $w = Get-Content $WinMain
            $w = $w -replace 'L"RustDesk"', 'L"Saurus Remote"'
            $w | Set-Content $WinMain
        }
        Write-Host "Customizacoes completas aplicadas."

    # --- BUILD ---
    - name: Build Saurus Client
      run: python build.py --flutter
      env:
        # Garante tripla estatica
        VCPKG_DEFAULT_TRIPLET: "x64-windows-static"
        # CORREÇÃO CRÍTICA:
        # 1. Usa barras normais (/) para evitar erro de escape do Windows
        # 2. Define CPATH que é onde o Clang busca headers nativamente
        BINDGEN_EXTRA_CLANG_ARGS: "-IC:/vcpkg/installed/x64-windows-static/include"
        CPATH: "C:\\vcpkg\\installed\\x64-windows-static\\include"

    - name: Upload .exe
      uses: actions/upload-artifact@v4
      with:
        name: Saurus-Remote-Client
        path: |
           target/release/rustdesk.exe
           output/rustdesk.exe
