name: Build Saurus Remote (Turbo Cache)

on:
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-2022
    
    env:
      LIBCLANG_PATH: "C:\\Program Files\\LLVM\\bin"
      RUSTDESK_API_SERVER: "" 
      # Configura o VCPKG para usar cache local de binarios
      VCPKG_BINARY_SOURCES: "clear;default,readwrite"

    steps:
    - name: Checkout source code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    # --- CAMADA 1: CACHE DO RUST (Cargo) ---
    - name: Cache Rust Dependencies
      uses: swatinem/rust-cache@v2
      with:
        workspaces: .

    # --- CAMADA 2: CACHE DAS BIBLIOTECAS C++ (VCPKG) - O MAIS IMPORTANTE ---
    - name: Cache VCPKG Archives
      uses: actions/cache@v4
      with:
        # Caminho onde o VCPKG guarda os binarios compilados
        path: C:\Users\runneradmin\AppData\Local\vcpkg\archives
        # A chave muda se o arquivo vcpkg.json mudar. Se nao mudar, usa o cache.
        key: vcpkg-archives-${{ runner.os }}-${{ hashFiles('vcpkg.json') }}
        restore-keys: |
          vcpkg-archives-${{ runner.os }}-

    # --- CAMADA 3: CACHE DO FLUTTER ---
    - name: Cache Flutter Packages
      uses: actions/cache@v4
      with:
        path: |
          flutter/.pub-cache
          flutter/.dart_tool
        key: flutter-pub-${{ runner.os }}-${{ hashFiles('flutter/pubspec.yaml') }}
        restore-keys: |
          flutter-pub-${{ runner.os }}-

    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.22.2'
        channel: 'stable'

    - name: Install LLVM
      run: |
        choco install llvm -y
        echo "C:\Program Files\LLVM\bin" >> $env:GITHUB_PATH
      shell: powershell

    # --- AJUSTES DE DEPENDÊNCIAS ---
    - name: Force Downgrade extended_text
      working-directory: ./flutter
      shell: powershell
      run: |
        $File = "pubspec.yaml"
        $Content = Get-Content $File -Raw
        $NewContent = $Content -replace 'extended_text:.*', 'extended_text: ^13.0.0'
        Set-Content -Path $File -Value $NewContent -Encoding UTF8

    - name: Prepare Flutter Dependencies
      working-directory: ./flutter
      run: flutter pub get
      shell: cmd

    - name: Install Flutter Rust Bridge Codegen
      run: |
        cargo install flutter_rust_bridge_codegen --version 1.80.1 --features uuid
      shell: powershell

    - name: Generate Bridge Code
      shell: powershell
      run: |
        $env:PATH += ";C:\Users\runneradmin\.cargo\bin"
        flutter_rust_bridge_codegen --rust-input src/flutter_ffi.rs --dart-output flutter/lib/generated_bridge.dart --rust-output src/bridge_generated.rs

    # --- INSTALAÇÃO VCPKG (AGORA COM CACHE) ---
    - name: Install Dependencies & Fix Paths
      shell: powershell
      run: |
        Write-Host "Iniciando instalacao (Verificando Cache)..."
        # O VCPKG vai detectar o cache configurado acima e pular a compilacao se existir
        vcpkg install --triplet x64-windows-static
        
        $BaseDir = Get-Location
        $IncludePath = Join-Path $BaseDir "vcpkg_installed\x64-windows-static\include"
        $LibPath = Join-Path $BaseDir "vcpkg_installed\x64-windows-static\lib"
        
        echo "BINDGEN_EXTRA_CLANG_ARGS=-I$IncludePath" >> $env:GITHUB_ENV
        echo "CPATH=$IncludePath" >> $env:GITHUB_ENV
        echo "RUSTFLAGS=-L native=$LibPath" >> $env:GITHUB_ENV
        echo "VCPKG_ROOT=$BaseDir" >> $env:GITHUB_ENV

    # --- CUSTOMIZAÇÃO ---
    - name: Apply Customizations (Branding)
      shell: powershell
      run: |
        $UrlIcone = "https://blob.saurus.net.br/drive/clientes/cliente_testeslucaspt1/icoRust.ico"
        $UrlLogo  = "https://blob.saurus.net.br/drive/clientes/cliente_testeslucaspt1/logoRust.png"
        
        try {
            Invoke-WebRequest -Uri $UrlIcone -OutFile "res/icon.ico" -ErrorAction Stop
            Invoke-WebRequest -Uri $UrlLogo -OutFile "res/logo.png" -ErrorAction Stop
            if (Test-Path "flutter/assets/images/logo.png") {
                Copy-Item "res/logo.png" -Destination "flutter/assets/images/logo.png" -Force
            }
        } catch { Write-Warning "Erro baixar logos." }

        $SafraBlue = "0xFF1E2044" 
        $CommonFile = "flutter/lib/common.dart"
        if (Test-Path $CommonFile) {
            $c = Get-Content $CommonFile
            $c = $c -replace '0xFF2196F3', $SafraBlue
            $c | Set-Content $CommonFile
        }

        $ConfigFile = "libs/hbb_common/src/config.rs"
        if (Test-Path $ConfigFile) {
           $c = Get-Content $ConfigFile
           $c = $c -replace 'pub const APP_NAME.*', 'pub const APP_NAME: Arc<RwLock<String>> = Arc::new(RwLock::new("Saurus Remote".to_string()));'
           $c = $c -replace 'pub const RENDEZVOUS_SERVERS:.*', 'pub const RENDEZVOUS_SERVERS: &''static [&''static str] = &["20.195.216.23"];'
           $c = $c -replace 'pub const RS_PUB_KEY:.*', 'pub const RS_PUB_KEY: &''static str = "20.195.216.23";'
           $c | Set-Content $ConfigFile
        }
        
        $WinMain = "windows/runner/main.cpp"
        if (Test-Path $WinMain) {
            $w = Get-Content $WinMain
            $w = $w -replace 'L"RustDesk"', 'L"Saurus Remote"'
            $w | Set-Content $WinMain
        }

    # --- BUILD ---
    - name: Build Saurus Client
      run: python build.py --flutter
      env:
        VCPKG_DEFAULT_TRIPLET: "x64-windows-static"
    
    # --- UPLOAD SEGURO ---
    - name: Find and Prepare Exe
      shell: powershell
      run: |
        New-Item -ItemType Directory -Force -Path "SAIDA_FINAL"
        $ExeFile = Get-ChildItem -Path "build" -Recurse -Filter "*.exe" | Where-Object { $_.DirectoryName -like "*Release*" } | Select-Object -First 1
        
        if ($ExeFile) {
            Write-Host "ENCONTRADO: $($ExeFile.FullName)"
            Copy-Item -Path $ExeFile.FullName -Destination "SAIDA_FINAL\SaurusRemote.exe"
        } else {
            Write-Error "ERRO CRITICO: Nenhum .exe foi encontrado!"
            exit 1
        }

    - name: Upload .exe
      uses: actions/upload-artifact@v4
      with:
        name: Saurus-Remote-Client
        path: SAIDA_FINAL
