name: Build Saurus Legacy (32-bit Final Direct)

on:
  workflow_dispatch:

jobs:
  build-legacy:
    runs-on: windows-2019
    
    env:
      RUSTDESK_API_SERVER: ""

    steps:
    - name: Checkout Legacy Code (1.1.9)
      uses: actions/checkout@v4
      with:
        repository: rustdesk/rustdesk
        ref: 1.1.9
        submodules: recursive

    - name: Setup Rust (1.65.0)
      uses: dtolnay/rust-toolchain@master
      with:
        toolchain: 1.65.0
        targets: i686-pc-windows-msvc

    - name: Install Legacy LLVM
      run: choco install llvm --version 12.0.0 --allow-downgrade -y

    # --- SETUP LIBSODIUM MANUAL ---
    - name: Setup Libsodium (Manual)
      shell: powershell
      run: |
        $Url = "https://download.libsodium.org/libsodium/releases/libsodium-1.0.18-msvc.zip"
        $Zip = "libsodium.zip"
        Write-Host "Baixando Libsodium..."
        & curl.exe -L -o $Zip $Url --retry 5 --retry-connrefused --connect-timeout 60
        
        if ((Get-Item $Zip).Length -lt 1000) { throw "Arquivo libsodium.zip muito pequeno/corrompido" }

        Expand-Archive -Path $Zip -DestinationPath "libsodium_install" -Force
        
        New-Item -ItemType Directory -Force -Path "C:\libs\sodium\lib"
        New-Item -ItemType Directory -Force -Path "C:\libs\sodium\include"
        
        $LibSrc = "libsodium_install\libsodium\Win32\Release\v142\static\libsodium.lib"
        Copy-Item $LibSrc "C:\libs\sodium\lib\sodium.lib" -Force
        Copy-Item "libsodium_install\libsodium\include\*" "C:\libs\sodium\include" -Recurse -Force
        Write-Host "Libsodium OK."

    - name: Inject Server Configuration
      shell: powershell
      run: |
        $ConfigFile = "libs/hbb_common/src/config.rs"
        $SeuIP = "20.195.216.23:443"
        $SuaChave = "OJ7QiUrqNu0wM13vDSp4nmAlDu6hy3n8hTI5Wksl2Tc="
        if (Test-Path $ConfigFile) {
           $content = Get-Content $ConfigFile -Raw
           $content = $content -replace '(?s)pub const RENDEZVOUS_SERVERS:.*?;', "pub const RENDEZVOUS_SERVERS: &'static [&'static str] = &[`"$SeuIP`"];"
           $content = $content -replace '(?s)pub const RS_PUB_KEY:.*?;', "pub const RS_PUB_KEY: &'static str = `"$SuaChave`";"
           Set-Content -Path $ConfigFile -Value $content -Encoding UTF8
        }

    - name: Fix Legacy Code Logic (Locks)
      shell: powershell
      run: |
        $ConfigFile = "libs\hbb_common\src\config.rs"
        $content = Get-Content $ConfigFile -Raw
        $content = $content -replace "let _ = CONFIG.read\(\).unwrap\(\);", "let _lock = CONFIG.read().unwrap();"
        Set-Content -Path $ConfigFile -Value $content -Encoding UTF8

    - name: Generate Inline UI Assets
      shell: python
      run: |
        import os
        mapping = { "get_index": "index.html", "get_chatbox": "chatbox.html", "get_cm": "cm.html", "get_install": "install.html", "get_remote": "remote.html" }
        with open("src/ui/inline.rs", "w") as f:
            for func, filename in mapping.items():
                if os.path.exists(f"src/ui/{filename}"):
                    f.write(f'pub fn {func}() -> String {{ String::from_utf8_lossy(include_bytes!("{filename}")).to_string() }}\n')
                else:
                    f.write(f'pub fn {func}() -> String {{ String::new() }}\n')

    - name: Ensure Resources Exist
      shell: powershell
      run: |
        $icon = Get-ChildItem -Path . -Recurse -Filter "icon.ico" | Select-Object -First 1
        if ($icon) { Copy-Item $icon.FullName -Destination ".\icon.ico" -Force } 
        else { & curl.exe -L -o icon.ico "https://raw.githubusercontent.com/rustdesk/rustdesk/master/res/icon.ico" --retry 3 }
        $manifest = Get-ChildItem -Path . -Recurse -Filter "manifest.xml" | Select-Object -First 1
        if ($manifest) { Copy-Item $manifest.FullName -Destination ".\manifest.xml" -Force } 
        else { & curl.exe -L -o manifest.xml "https://raw.githubusercontent.com/rustdesk/rustdesk/master/res/manifest.xml" --retry 3 }

    - name: Fix Resource Paths in build.rs
      shell: powershell
      run: |
        $BuildRs = "build.rs"
        $AbsPath = (Get-Location).Path.Replace("\", "\\")
        $content = Get-Content $BuildRs -Raw
        $content = $content.Replace('"icon.ico"', "`"$AbsPath\\icon.ico`"")
        $content = $content.Replace('"manifest.xml"', "`"$AbsPath\\manifest.xml`"")
        Set-Content -Path $BuildRs -Value $content -Encoding UTF8

    # --- DOWNLOAD SCITER DLL (DIRETO E CORRETO) ---
    - name: Download Sciter DLL (Direct)
      shell: powershell
      run: |
        New-Item -ItemType Directory -Force -Path "target\release"
        
        # URL Direta para o arquivo no commit de 2021 (raw)
        # Isso evita baixar o ZIP e evita erros de "Bad Image" com versao errada
        $DllUrl = "https://raw.githubusercontent.com/c-smile/sciter-sdk/3636f3306d64998797e937d57bc8382da493026d/bin.win/x32/sciter.dll"
        
        Write-Host "Baixando sciter.dll (Raw Direct)..."
        & curl.exe -L -o target\release\sciter.dll $DllUrl --retry 5 --retry-connrefused
        
        # Validação de Segurança
        $size = (Get-Item "target\release\sciter.dll").Length
        Write-Host "Tamanho do arquivo baixado: $size bytes"
        
        if ($size -lt 2000000) { 
            # Se for menor que 2MB, provavelmente é um erro HTML (404) ou arquivo corrompido
            Get-Content "target\release\sciter.dll" -TotalCount 5
            Write-Error "FALHA: O arquivo sciter.dll está corrompido ou é inválido."
            exit 1 
        }

    # --- BUILD FINAL ---
    - name: Build Legacy
      run: |
        $env:LIBCLANG_PATH = "C:\Program Files\LLVM\bin"
        $env:SODIUM_LIB_DIR = "C:\libs\sodium\lib"
        $env:SODIUM_SHARED = "false"
        
        # Flags para usar nossas libs manuais e ignorar VCPKG que está com erro
        $env:CARGO_TARGET_I686_PC_WINDOWS_MSVC_RUSTFLAGS = "-C target-feature=+crt-static -L native=C:\libs\sodium\lib -l static=sodium"
        
        # Tentamos compilar sem VCPKG. O Rust vai baixar o fallback das libs multimidia se precisar.
        cargo build --target i686-pc-windows-msvc --release --features inline
      shell: powershell

    - name: Package Legacy
      shell: powershell
      run: |
        New-Item -ItemType Directory -Force -Path "Saurus_Legacy_32bit"
        Copy-Item "target\i686-pc-windows-msvc\release\rustdesk.exe" "Saurus_Legacy_32bit\SaurusRemote_Legacy.exe"
        Copy-Item "target\release\sciter.dll" "Saurus_Legacy_32bit\"
        Write-Host "Pacote Legacy Criado!"

    - name: Upload Legacy
      uses: actions/upload-artifact@v4
      with:
        name: Saurus-Remote-Legacy-32bit
        path: Saurus_Legacy_32bit
