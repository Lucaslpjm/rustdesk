name: Build Saurus Installer (v67 - Flexible Source Patch)

on:
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-2022
    
    env:
      LIBCLANG_PATH: "C:\\Program Files\\LLVM\\bin"
      RUSTDESK_API_SERVER: "" 
      VCPKG_BINARY_SOURCES: "clear;default,readwrite"

    steps:
    - name: Checkout source code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    # --- CACHES ---
    - name: Cache Rust Dependencies
      uses: swatinem/rust-cache@v2
      with:
        workspaces: .

    - name: Cache VCPKG Archives
      uses: actions/cache@v4
      with:
        path: C:\Users\runneradmin\AppData\Local\vcpkg\archives
        key: vcpkg-archives-${{ runner.os }}-${{ hashFiles('vcpkg.json') }}
        restore-keys: |
          vcpkg-archives-${{ runner.os }}-

    - name: Cache Flutter Packages
      uses: actions/cache@v4
      with:
        path: |
          flutter/.pub-cache
          flutter/.dart_tool
        key: flutter-pub-${{ runner.os }}-${{ hashFiles('flutter/pubspec.yaml') }}
        restore-keys: |
          flutter-pub-${{ runner.os }}-

    # --- SETUP ---
    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.22.2'
        channel: 'stable'

    - name: Install LLVM & Inno Setup
      run: |
        choco install llvm -y
        choco install innosetup -y
        echo "C:\Program Files\LLVM\bin" >> $env:GITHUB_PATH
      shell: powershell

    # --- PATCH PROFUNDO NO CÓDIGO FONTE (A SOLUÇÃO REAL) ---
    - name: Hardcode Settings in Source (Flexible Regex)
      shell: powershell
      run: |
        Write-Host "Aplicando Patch Cirúrgico nas Configurações..."
        $ConfigFile = "libs/hbb_common/src/config.rs"
        
        # Injeção de Servidor
        $SeuIP = "20.195.216.23:443" 
        $SuaChave = "OJ7QiUrqNu0wM13vDSp4nmAlDu6hy3n8hTI5Wksl2Tc=" 
        
        if (Test-Path $ConfigFile) {
           $c = Get-Content $ConfigFile -Raw
           
           # 1. Configurar Servidor
           $c = $c -replace '(?s)pub const RENDEZVOUS_SERVERS:.*?;', "pub const RENDEZVOUS_SERVERS: &'static [&'static str] = &[`"$SeuIP`"];"
           $c = $c -replace '(?s)pub const RS_PUB_KEY:.*?;', "pub const RS_PUB_KEY: &'static str = `"$SuaChave`";"

           # 2. Alterar Defaults das Structs (Usando Regex flexível para espaços)
           # A ideia é interceptar a definição da struct e adicionar o atributo #[serde(default...)]
           
           # Check Update -> FALSE
           $c = [Regex]::Replace($c, 'pub\s+check_update\s*:\s*bool\s*,', '#[serde(default = "default_false")] pub check_update: bool,')
           
           # Remove Wallpaper -> TRUE
           $c = [Regex]::Replace($c, 'pub\s+remove_wallpaper\s*:\s*bool\s*,', '#[serde(default = "default_true")] pub remove_wallpaper: bool,')
           
           # Direct Server (UDP) -> TRUE
           $c = [Regex]::Replace($c, 'pub\s+direct_server\s*:\s*bool\s*,', '#[serde(default = "default_true")] pub direct_server: bool,')
           
           # Hardware Codec -> TRUE
           $c = [Regex]::Replace($c, 'pub\s+hwcodec\s*:\s*bool\s*,', '#[serde(default = "default_true")] pub hwcodec: bool,')

           # 3. Adicionar as funções auxiliares no final do arquivo
           $DefaultFuncs = @"
           
           // SAURUS PATCH FUNCTIONS
           fn default_true() -> bool { true }
           fn default_false() -> bool { false }
           "@
           
           if (-not $c.Contains("fn default_true")) {
               $c = $c + $DefaultFuncs
           }

           Set-Content -Path $ConfigFile -Value $c -Encoding UTF8
           Write-Host "Código fonte modificado com sucesso!"
        } else {
           Write-Error "Arquivo config.rs não encontrado!"
           exit 1
        }

    # --- PREPARAÇÃO ---
    - name: Fix Flutter Dependencies
      working-directory: ./flutter
      shell: powershell
      run: |
        $File = "pubspec.yaml"
        $Content = Get-Content $File -Raw
        $NewContent = $Content -replace 'extended_text:.*', 'extended_text: ^13.0.0'
        Set-Content -Path $File -Value $NewContent -Encoding UTF8

    - name: Prepare Flutter Dependencies
      working-directory: ./flutter
      run: flutter pub get
      shell: cmd

    - name: Install Flutter Rust Bridge Codegen
      run: |
        cargo install flutter_rust_bridge_codegen --version 1.80.1 --features uuid
      shell: powershell

    - name: Generate Bridge Code
      shell: powershell
      run: |
        $env:PATH += ";C:\Users\runneradmin\.cargo\bin"
        flutter_rust_bridge_codegen --rust-input src/flutter_ffi.rs --dart-output flutter/lib/generated_bridge.dart --rust-output src/bridge_generated.rs

    - name: Install C++ Libs (VCPKG)
      shell: powershell
      run: |
        vcpkg install --triplet x64-windows-static
        $BaseDir = Get-Location
        $IncludePath = Join-Path $BaseDir "vcpkg_installed\x64-windows-static\include"
        $LibPath = Join-Path $BaseDir "vcpkg_installed\x64-windows-static\lib"
        echo "BINDGEN_EXTRA_CLANG_ARGS=-I$IncludePath" >> $env:GITHUB_ENV
        echo "CPATH=$IncludePath" >> $env:GITHUB_ENV
        echo "RUSTFLAGS=-L native=$LibPath" >> $env:GITHUB_ENV
        echo "VCPKG_ROOT=$BaseDir" >> $env:GITHUB_ENV

    # --- BUILD ---
    - name: Build RustDesk
      run: python build.py --flutter
      env:
        VCPKG_DEFAULT_TRIPLET: "x64-windows-static"
    
    # --- GERAR ARQUIVO DE CONFIGURAÇÃO (BACKUP) ---
    - name: Generate Config Backup
      shell: powershell
      run: |
        $ConfigContent = @"
        stop-service = false
        [options]
        check-update = false
        auto-update = false
        confirm-close = true
        remove-wallpaper = true
        direct-server = true
        enable-ipv6 = true
        hwcodec = true
        use-d3d = true
        capture-directx = true
        view-scale = 'adaptive'
        scroll-style = 'auto'
        view-quality = 'low'
        "@
        Set-Content -Path "RustDesk2.toml" -Value $ConfigContent -Encoding UTF8

    # --- EMPACOTAMENTO PRO ---
    - name: Create Power Installer
      shell: powershell
      run: |
        Write-Host "Criando instalador..."
        $StageDir = "Staging_Area"
        New-Item -ItemType Directory -Force -Path $StageDir
        
        $Files = Get-ChildItem -Path . -Recurse -Filter "rustdesk.exe" | Where-Object { $_.FullName -notmatch "vcpkg" } | Select-Object -First 1
        $SourceFolder = $Files.Directory.FullName
        Copy-Item "$SourceFolder\rustdesk.exe" $StageDir
        Copy-Item "$SourceFolder\*.dll" $StageDir
        if (Test-Path "$SourceFolder\data") { Copy-Item "$SourceFolder\data" $StageDir -Recurse }
        
        $VcUrl = "https://aka.ms/vs/17/release/vc_redist.x64.exe"
        Invoke-WebRequest -Uri $VcUrl -OutFile "$StageDir\vc_redist.x64.exe"
        
        # Script Inno Setup Otimizado
        $IssContent = @"
        [Setup]
        AppName=RustDesk
        AppVersion=1.2.4
        DefaultDirName={autopf}\RustDesk
        DefaultGroupName=RustDesk
        UninstallDisplayIcon={app}\rustdesk.exe
        Compression=lzma2
        SolidCompression=yes
        OutputDir=.
        OutputBaseFilename=Saurus_Instalador
        PrivilegesRequired=admin
        CloseApplications=yes

        [Dirs]
        Name: "{commonappdata}\RustDesk\config"; Permissions: users-modify

        [Files]
        Source: "Staging_Area\*"; DestDir: "{app}"; Flags: ignoreversion recursesubdirs createallsubdirs
        
        ; Copia para pasta GLOBAL (Todos os usuários leem daqui se não tiverem config propria)
        Source: "RustDesk2.toml"; DestDir: "{commonappdata}\RustDesk\config"; Flags: ignoreversion

        ; Copia para pasta do Executável (Portable Mode Trigger)
        Source: "RustDesk2.toml"; DestDir: "{app}"; Flags: ignoreversion

        Source: "Staging_Area\vc_redist.x64.exe"; DestDir: "{tmp}"; Flags: deleteafterinstall

        [Registry]
        ; Força a chave de update no registro para o usuário atual (mesmo que seja admin instalando)
        Root: HKCU; Subkey: "Software\RustDesk"; ValueType: string; ValueName: "check-update"; ValueData: "false"; Flags: uninsdeletevalue
        Root: HKLM; Subkey: "Software\RustDesk"; ValueType: string; ValueName: "check-update"; ValueData: "false"; Flags: uninsdeletevalue

        [Icons]
        Name: "{group}\RustDesk"; Filename: "{app}\rustdesk.exe"
        Name: "{autodesktop}\RustDesk"; Filename: "{app}\rustdesk.exe"; Tasks: desktopicon

        [Tasks]
        Name: "desktopicon"; Description: "Criar atalho na Area de Trabalho"; GroupDescription: "Atalhos:"; Flags: unchecked

        [Run]
        Filename: "{tmp}\vc_redist.x64.exe"; Parameters: "/install /quiet /norestart"; StatusMsg: "Instalando componentes..."; Flags: waituntilterminated
        Filename: "{app}\rustdesk.exe"; Description: "Abrir Saurus Remote"; Flags: nowait postinstall skipifsilent
        "@
        
        Set-Content -Path "setup.iss" -Value $IssContent -Encoding ASCII
        
        & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" setup.iss

    - name: Upload Power Installer
      uses: actions/upload-artifact@v4
      with:
        name: Saurus-Instalador-Completo
        path: Saurus_Instalador.exe
