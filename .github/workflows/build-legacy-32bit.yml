name: Build Saurus Legacy (32-bit Bulletproof)

on:
  workflow_dispatch:

jobs:
  build-legacy:
    runs-on: windows-2019
    
    env:
      RUSTDESK_API_SERVER: ""
      VCPKG_ROOT: "C:\\vcpkg"
      # Não definimos triplet global para evitar confusão no host

    steps:
    # 1. Baixar Código Fonte
    - name: Checkout Legacy Code (1.1.9)
      uses: actions/checkout@v4
      with:
        repository: rustdesk/rustdesk
        ref: 1.1.9
        submodules: recursive

    # 2. Configurar Rust 1.65 (Compatível com código de 2021)
    - name: Setup Rust
      uses: dtolnay/rust-toolchain@master
      with:
        toolchain: 1.65.0
        targets: i686-pc-windows-msvc

    # 3. Instalar Ferramentas Básicas
    - name: Install Build Tools
      run: choco install llvm nasm yasm --version 12.0.0 --allow-downgrade -y

    # 4. Instalar Dependências VCPKG (Opus, VPX, YUV) - Com Retry Loop
    - name: Install VCPKG Dependencies (Robust)
      shell: powershell
      run: |
        $ErrorActionPreference = "Stop"
        
        # Clone
        if (!(Test-Path C:\vcpkg)) { git clone https://github.com/microsoft/vcpkg.git C:\vcpkg }
        cd C:\vcpkg
        
        # Bootstrap
        cmd /c "bootstrap-vcpkg.bat -disableMetrics"
        .\vcpkg integrate install
        
        # Loop de Instalação (5 tentativas)
        $maxRetries = 5
        $retryCount = 0
        $success = $false
        
        while (-not $success -and $retryCount -lt $maxRetries) {
            try {
                Write-Host "Tentativa de instalacao VCPKG ($($retryCount + 1)/$maxRetries)..."
                # Instala apenas midia. Libsodium instalaremos manualmente para evitar conflito.
                cmd /c "vcpkg install libvpx:x86-windows-static libyuv:x86-windows-static opus:x86-windows-static"
                
                if ($LASTEXITCODE -eq 0) {
                    $success = $true
                    Write-Host "Sucesso no VCPKG!"
                } else { throw "Erro no VCPKG" }
            } catch {
                Write-Warning "Falha no download/build. Retentando em 15s..."
                Start-Sleep -Seconds 15
                $retryCount++
            }
        }
        if (-not $success) { throw "Falha Fatal VCPKG" }

    # 5. Instalar Libsodium Manualmente (Isolamento x86)
    - name: Setup Libsodium (Manual 32-bit)
      shell: powershell
      run: |
        $Url = "https://download.libsodium.org/libsodium/releases/libsodium-1.0.18-msvc.zip"
        $Zip = "libsodium.zip"
        
        # Download com Curl e Retry
        & curl.exe -L -o $Zip $Url --retry 5 --retry-connrefused --connect-timeout 60
        
        if (!(Test-Path $Zip)) { throw "Erro no download do Libsodium" }
        
        Expand-Archive -Path $Zip -DestinationPath "libsodium_install" -Force
        
        # Cria pasta isolada
        New-Item -ItemType Directory -Force -Path "C:\libs_x86\lib"
        New-Item -ItemType Directory -Force -Path "C:\libs_x86\include"
        
        # Copia a lib estatica 32-bits
        $Src = "libsodium_install\libsodium\Win32\Release\v142\static\libsodium.lib"
        Copy-Item $Src "C:\libs_x86\lib\libsodium.lib" -Force
        Copy-Item $Src "C:\libs_x86\lib\sodium.lib" -Force
        Copy-Item "libsodium_install\libsodium\include\*" "C:\libs_x86\include" -Recurse -Force
        
        Write-Host "Libsodium manual OK em C:\libs_x86"

    # 6. Baixar Sciter DLL (Via Git - Infalível)
    - name: Download Sciter DLL (Git Method)
      shell: powershell
      run: |
        New-Item -ItemType Directory -Force -Path "target\release"
        
        if (Test-Path "sciter_repo") { Remove-Item "sciter_repo" -Recurse -Force }
        
        Write-Host "Clonando repositorio Sciter..."
        git clone https://github.com/c-smile/sciter-sdk.git sciter_repo
        
        cd sciter_repo
        # Checkout no commit de Setembro 2021 (Compativel com RustDesk 1.1.9)
        Write-Host "Restaurando versao 2021..."
        git checkout 3636f3306d64998797e937d57bc8382da493026d
        cd ..
        
        $DllPath = "sciter_repo\bin.win\x32\sciter.dll"
        if (Test-Path $DllPath) {
            Copy-Item $DllPath "target\release\sciter.dll" -Force
            Write-Host "DLL Sciter 32-bit restaurada com sucesso!"
        } else {
            throw "DLL nao encontrada no repositorio clonado!"
        }

    # 7. Configurar Código (Servidor, Icones, Python UI)
    - name: Configure Codebase
      shell: powershell
      run: |
        # Injeta Servidor Saurus
        $ConfigFile = "libs/hbb_common/src/config.rs"
        $SeuIP = "20.195.216.23:443"
        $SuaChave = "OJ7QiUrqNu0wM13vDSp4nmAlDu6hy3n8hTI5Wksl2Tc="
        
        if (Test-Path $ConfigFile) {
           $c = Get-Content $ConfigFile -Raw
           $c = $c -replace '(?s)pub const RENDEZVOUS_SERVERS:.*?;', "pub const RENDEZVOUS_SERVERS: &'static [&'static str] = &[`"$SeuIP`"];"
           $c = $c -replace '(?s)pub const RS_PUB_KEY:.*?;', "pub const RS_PUB_KEY: &'static str = `"$SuaChave`";"
           # Fix de Lock
           $c = $c -replace "let _ = CONFIG.read\(\).unwrap\(\);", "let _lock = CONFIG.read().unwrap();"
           Set-Content -Path $ConfigFile -Value $c -Encoding UTF8
        }

        # Baixa Icones (Com Curl)
        & curl.exe -L -o icon.ico "https://raw.githubusercontent.com/rustdesk/rustdesk/master/res/icon.ico" --retry 3
        & curl.exe -L -o manifest.xml "https://raw.githubusercontent.com/rustdesk/rustdesk/master/res/manifest.xml" --retry 3
        
        # Ajusta caminhos no build.rs
        $BuildRs = "build.rs"
        $AbsPath = (Get-Location).Path.Replace("\", "\\")
        $c = Get-Content $BuildRs -Raw
        $c = $c.Replace('"icon.ico"', "`"$AbsPath\\icon.ico`"")
        $c = $c.Replace('"manifest.xml"', "`"$AbsPath\\manifest.xml`"")
        Set-Content -Path $BuildRs -Value $c -Encoding UTF8

    - name: Generate Inline UI (Python)
      shell: python
      run: |
        import os
        mapping = { "get_index": "index.html", "get_chatbox": "chatbox.html", "get_cm": "cm.html", "get_install": "install.html", "get_remote": "remote.html" }
        with open("src/ui/inline.rs", "w") as f:
            for func, filename in mapping.items():
                if os.path.exists(f"src/ui/{filename}"):
                    f.write(f'pub fn {func}() -> String {{ String::from_utf8_lossy(include_bytes!("{filename}")).to_string() }}\n')
                else:
                    f.write(f'pub fn {func}() -> String {{ String::new() }}\n')

    # 8. BUILD FINAL (AQUI A MAGICA ACONTECE)
    - name: Build Legacy
      run: |
        $env:LIBCLANG_PATH = "C:\Program Files\LLVM\bin"
        $env:BINDGEN_EXTRA_CLANG_ARGS = "-I C:/vcpkg/installed/x86-windows-static/include"
        
        # Configurações Manuais do VCPKG (Opus/VPX)
        $env:OPUS_LIB_DIR = "C:\vcpkg\installed\x86-windows-static\lib"
        $env:OPUS_INCLUDE_DIR = "C:\vcpkg\installed\x86-windows-static\include"
        $env:OPUS_STATIC = "1"
        $env:DEP_VPX_LIB = "C:\vcpkg\installed\x86-windows-static\lib"
        $env:DEP_VPX_INCLUDE = "C:\vcpkg\installed\x86-windows-static\include"
        
        # Configuração Manual do Sodium (Ignora VCPKG)
        $env:SODIUM_LIB_DIR = "C:\libs_x86\lib"
        $env:SODIUM_SHARED = "false"
        
        # TARGET FLAGS (O Segredo):
        # Essas flags SÓ são aplicadas quando o Rust compila o "rustdesk.exe" (32-bits).
        # O script de build (64-bits) não vê essas flags e não tenta linkar a lib errada.
        # - crt-static: Garante que tudo vai dentro do EXE.
        # - L native: Adiciona os caminhos das nossas libs manuais e do VCPKG.
        # - l static=sodium: Força o uso da nossa libsodium manual.
        
        $env:CARGO_TARGET_I686_PC_WINDOWS_MSVC_RUSTFLAGS = "-C target-feature=+crt-static -L native=C:\vcpkg\installed\x86-windows-static\lib -L native=C:\libs_x86\lib -l static=libsodium"
        
        Write-Host "Iniciando compilacao..."
        cargo build --target i686-pc-windows-msvc --release --features inline
      shell: powershell

    - name: Package Legacy
      shell: powershell
      run: |
        New-Item -ItemType Directory -Force -Path "Saurus_Legacy_32bit"
        Copy-Item "target\i686-pc-windows-msvc\release\rustdesk.exe" "Saurus_Legacy_32bit\SaurusRemote_Legacy.exe"
        Copy-Item "target\release\sciter.dll" "Saurus_Legacy_32bit\"
        Write-Host "Pacote Legacy Criado com Sucesso!"

    - name: Upload Legacy
      uses: actions/upload-artifact@v4
      with:
        name: Saurus-Remote-Legacy-32bit
        path: Saurus_Legacy_32bit
