name: Build Saurus Legacy (32-bit / Win7)

on:
  workflow_dispatch:

jobs:
  build-legacy:
    runs-on: windows-2019
    
    env:
      VCPKG_DEFAULT_TRIPLET: x86-windows-static
      RUSTDESK_API_SERVER: ""

    steps:
    - name: Checkout Legacy Code (1.1.9)
      uses: actions/checkout@v4
      with:
        repository: rustdesk/rustdesk
        ref: 1.1.9
        submodules: recursive

    - name: Cache VCPKG
      uses: actions/cache@v4
      with:
        path: C:\vcpkg
        key: vcpkg-legacy-x86-${{ hashFiles('vcpkg.json') }}
        restore-keys: vcpkg-legacy-x86-

    - name: Setup Rust (32-bit Legacy)
      uses: dtolnay/rust-toolchain@master
      with:
        toolchain: 1.65.0
        targets: i686-pc-windows-msvc

    - name: Install Legacy LLVM
      run: choco install llvm --version 12.0.0 --allow-downgrade -y

    - name: Inject Server Configuration
      shell: powershell
      run: |
        Write-Host "Injetando Servidor Saurus (Legacy)..."
        $ConfigFile = "libs/hbb_common/src/config.rs"
        
        $SeuIP = "20.195.216.23:443"
        $SuaChave = "OJ7QiUrqNu0wM13vDSp4nmAlDu6hy3n8hTI5Wksl2Tc="
        
        if (Test-Path $ConfigFile) {
           $content = Get-Content $ConfigFile -Raw
           $content = $content -replace '(?s)pub const RENDEZVOUS_SERVERS:.*?;', "pub const RENDEZVOUS_SERVERS: &'static [&'static str] = &[`"$SeuIP`"];"
           $content = $content -replace '(?s)pub const RS_PUB_KEY:.*?;', "pub const RS_PUB_KEY: &'static str = `"$SuaChave`";"
           Set-Content -Path $ConfigFile -Value $content -Encoding UTF8
           Write-Host "Configurado com sucesso!"
        }

    - name: Fix Legacy Code Logic (Locks)
      shell: powershell
      run: |
        Write-Host "Corrigindo bug de Lock..."
        $ConfigFile = "libs\hbb_common\src\config.rs"
        $content = Get-Content $ConfigFile -Raw
        $content = $content -replace "let _ = CONFIG.read\(\).unwrap\(\);", "let _lock = CONFIG.read().unwrap();"
        Set-Content -Path $ConfigFile -Value $content -Encoding UTF8

    # --- CORREÇÃO DE RECURSOS (BUSCA INTELIGENTE) ---
    - name: Ensure Resources Exist at Root
      shell: powershell
      run: |
        Write-Host "Procurando icon.ico e manifest.xml em qualquer lugar..."
        
        # 1. Tenta achar o ICONE
        $icon = Get-ChildItem -Path . -Recurse -Filter "icon.ico" | Select-Object -First 1
        if ($icon) {
            Write-Host "Icone encontrado em: $($icon.FullName). Movendo para raiz..."
            Copy-Item $icon.FullName -Destination ".\icon.ico" -Force
        } else {
            Write-Warning "Icone nao encontrado no codigo! Baixando generico..."
            Invoke-WebRequest -Uri "https://raw.githubusercontent.com/rustdesk/rustdesk/master/icon.ico" -OutFile ".\icon.ico"
        }

        # 2. Tenta achar o MANIFESTO
        $manifest = Get-ChildItem -Path . -Recurse -Filter "manifest.xml" | Select-Object -First 1
        if ($manifest) {
            Write-Host "Manifesto encontrado em: $($manifest.FullName). Movendo para raiz..."
            Copy-Item $manifest.FullName -Destination ".\manifest.xml" -Force
        } else {
            Write-Warning "Manifesto nao encontrado! Baixando generico..."
            # Baixa um manifesto padrao se nao achar
            Invoke-WebRequest -Uri "https://raw.githubusercontent.com/rustdesk/rustdesk/master/manifest.xml" -OutFile ".\manifest.xml"
        }
        
        # Confirmação visual
        if (Test-Path ".\icon.ico") { Write-Host "OK: icon.ico esta na raiz." } else { Write-Error "FALHA: icon.ico nao esta na raiz." }
        if (Test-Path ".\manifest.xml") { Write-Host "OK: manifest.xml esta na raiz." } else { Write-Error "FALHA: manifest.xml nao esta na raiz." }

    - name: Fix Resource Paths in build.rs
      shell: powershell
      run: |
        Write-Host "Aplicando caminhos absolutos..."
        $BuildRs = "build.rs"
        $AbsPath = (Get-Location).Path.Replace("\", "\\")
        
        $content = Get-Content $BuildRs -Raw
        $content = $content.Replace('"icon.ico"', "`"$AbsPath\\icon.ico`"")
        $content = $content.Replace('"manifest.xml"', "`"$AbsPath\\manifest.xml`"")
        Set-Content -Path $BuildRs -Value $content -Encoding UTF8

    - name: Install Dependencies (VCPKG x86)
      run: |
        if (!(Test-Path C:\vcpkg)) { git clone https://github.com/microsoft/vcpkg.git C:\vcpkg }
        cd C:\vcpkg
        .\bootstrap-vcpkg.bat
        .\vcpkg integrate install
        .\vcpkg install libvpx:x86-windows-static libyuv:x86-windows-static opus:x86-windows-static
      shell: powershell

    - name: Download Sciter DLL
      shell: cmd
      run: |
        if not exist "target\release" mkdir target\release
        curl -L -o target\release\sciter.dll https://github.com/c-smile/sciter-sdk/raw/3636f3306d64998797e937d57bc8382da493026d/bin.win/x32/sciter.dll

    - name: Build Legacy
      run: |
        $env:VCPKG_ROOT = "C:\vcpkg"
        $env:LIBCLANG_PATH = "C:\Program Files\LLVM\bin"
        $env:BINDGEN_EXTRA_CLANG_ARGS = "-I C:/vcpkg/installed/x86-windows-static/include"
        
        cargo build --target i686-pc-windows-msvc --release --features inline
      shell: powershell

    - name: Package Legacy
      shell: powershell
      run: |
        New-Item -ItemType Directory -Force -Path "Saurus_Legacy_32bit"
        Copy-Item "target\i686-pc-windows-msvc\release\rustdesk.exe" "Saurus_Legacy_32bit\SaurusRemote_Legacy.exe"
        Copy-Item "target\release\sciter.dll" "Saurus_Legacy_32bit\"
        Write-Host "Pacote Legacy Criado!"

    - name: Upload Legacy
      uses: actions/upload-artifact@v4
      with:
        name: Saurus-Remote-Legacy-32bit
        path: Saurus_Legacy_32bit
